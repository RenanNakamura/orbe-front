<div class="relative h-full flex flex-col overflow-hidden">
  <div class="px-6 bg-foreground border-b h-16 flex-none flex items-center">
    <button
      (click)="openDrawer()"
      class="md:hidden sm:-ml-4 mr-2"
      mat-icon-button
      type="button">
      <mat-icon svgIcon="mat:menu"></mat-icon>
    </button>
    <div class="flex items-center gap-3">
      <img class="hidden sm:block flex-none w-9 h-9 rounded-full" src="assets/img/no-avatar.png" alt=""/>
      <div class="flex-1 truncate">
        <div class="font-semibold text-sm truncate">{{ conversation?.name }}</div>
        <div class="text-xs text-gray-500 truncate">
          {{ conversation?.ddi + conversation?.phoneNumber  | phoneMask }}
        </div>
      </div>
    </div>

    <span class="flex-1"></span>
  </div>

  <vex-scrollbar class="flex-1 overflow-hidden">
    <div 
      #messagesContainer
      class="conversation-messages-container">
      
      <!-- Loading indicator for older messages -->
      <div *ngIf="loadingMessages$.value && (messages$ | async)?.length > 0" 
           class="flex justify-center py-4">
        <mat-spinner diameter="24"></mat-spinner>
      </div>

      <!-- Messages list -->
      <div class="flex flex-col space-y-2 p-8" *ngIf="messages$ | async as messages">
        <ng-container *ngFor="let message of messages; trackBy: trackByMessageId">
          
          <!-- Customer Message (Left Side) -->
          <div *ngIf="isCustomerMessage(message.senderType)" 
               class="message-wrapper message-wrapper--customer">
            <div class="flex gap-2">
              <img src="assets/img/no-avatar.png" 
                   alt="Profile" 
                   class="message-avatar message-avatar--customer">
              <div class="flex flex-col space-y-1">
                <div class="message-bubble message-bubble--customer">
                  <span class="message-text">{{ getMessageText(message) }}</span>
                </div>
                <div class="message-time message-time--customer">
                  {{ message.createdAt | friendlyDate }}
                </div>
              </div>
            </div>
          </div>

          <!-- Bot/Agent Message (Right Side) -->
          <div *ngIf="!isCustomerMessage(message.senderType)" 
               class="message-wrapper message-wrapper--sent">
            <div class="flex flex-col items-end space-y-1">
              <div class="message-bubble" 
                   [ngClass]="{
                     'message-bubble--bot': isBotMessage(message.senderType),
                     'message-bubble--agent': isAgentMessage(message.senderType)
                   }">
                <span class="message-text">{{ getMessageText(message) }}</span>
              </div>
              <div class="message-time message-time--sent">
                <mat-icon *ngIf="isAgentMessage(message.senderType)" 
                          class="icon-xs" 
                          svgIcon="mat:done_all"></mat-icon>
                <span>{{ message.createdAt | friendlyDate }}</span>
              </div>
            </div>
          </div>

        </ng-container>

        <!-- Empty state -->
        <div *ngIf="messages.length === 0 && !loadingMessages$.value" 
             class="flex flex-col items-center justify-center h-full text-center py-12">
          <p class="text-gray-500 text-sm">Nenhuma mensagem ainda</p>
        </div>
      </div>

      <!-- Loading initial messages -->
      <div *ngIf="loadingMessages$.value && (messages$ | async)?.length === 0" 
           class="flex justify-center items-center h-full py-12">
        <mat-spinner diameter="32"></mat-spinner>
      </div>
    </div>
  </vex-scrollbar>

  <div class="flex-none bg-foreground border-t">
    <div class="relative h-16 flex items-center justify-between">
      <button
        [matMenuTriggerFor]="addMenuButton"
        class="z-10 ml-4"
        color="primary"
        mat-mini-fab
        type="button">
        <mat-icon svgIcon="mat:add"></mat-icon>
      </button>

      <mat-menu #addMenuButton="matMenu" xPosition="after" yPosition="above">
        <button mat-menu-item>
          <mat-icon matMenuItemIcon svgIcon="mat:attach_file"></mat-icon>
          <span>Upload File</span>
        </button>
        <mat-divider></mat-divider>
        <button mat-menu-item>
          <mat-icon matMenuItemIcon svgIcon="mat:text_snippet"></mat-icon>
          <span>Create Text Snippet</span>
        </button>
        <button mat-menu-item>
          <mat-icon matMenuItemIcon svgIcon="mat:draw"></mat-icon>
          <span>Start Drawing Canvas</span>
        </button>
        <button mat-menu-item>
          <mat-icon matMenuItemIcon svgIcon="mat:event"></mat-icon>
          <span>Schedule Meeting</span>
        </button>
      </mat-menu>

      <input
        class="z-0 absolute top-0 right-0 bottom-0 left-0 h-full w-full border-0 focus:border-0 px-20 bg-transparent"
        placeholder="Type your message ..."
        type="text"/>

      <button class="relative z-10 mr-4" mat-icon-button type="button">
        <mat-icon svgIcon="mat:send"></mat-icon>
      </button>
    </div>
  </div>
</div>
